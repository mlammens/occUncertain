---
title: "occUncertain-vigentte"
author: "Samuel Chang"
date: "3/5/2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{occUncertain-vigentte}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F, include = FALSE}
library(occUncertain)
data(Leopardus_wiedii_gbif)
# load("../data/Leopardus_wiedii_gbif.rda")
Leopardus_wiedii_gbif <- Leopardus_wiedii_gbif
```



*****
*****
# 1. Introduction

This vignette goes through the use of uncertainty meassures of species occurrence records in "occUncertainty: An R package for addressing uncertainty of species occurrence in species distribution". Here we demostrate how **occUncertain** can be used to transform uncertainty meassures from meters to decimal degrees. Perform itterations to assess occurrence records variability in the quantification of the extent area that encompass the inferred or projected sites of occurrence of a species, and the area within the extent polygon they occupy. 

## Input file
To demonstrate the use of the package occUncertain we used a set of 229 verified, georeferenced occurrence records for the margay (*Leopardus weidii*) a small wild cat native to Central and South America. These occurrences dataset are from the Global Biodiversity Information Facility (GBIF) and are included as part of the occUncertain package.

The data set requires to have at least four columns: 

```{r TableData,include=TRUE, echo=FALSE}
Leopardus_wiedii_gbif <- dplyr::select(Leopardus_wiedii_gbif, latitude, longitude, coordinateUncertaintyInMeters, species)
knitr::kable(head(Leopardus_wiedii_gbif))
```

1. Latitude in decimal degrees
1. Longitude in decimal degrees
1. Coordinate uncertainty in meters.
1. Name of taxa

# 2. `meters_to_decdeg` function

The function `meters_to_decdeg` transforms uncertainty from meters into decimal degrees for each occurence point. 
***Note 1*: Is impotant to consider the fact that as one moves away from the equator towards a pole, one degree of longitude is multiplied by the cosine of the latitude, decreasing the distance, approaching zero at the pole.  

The function allows interpretation of NA uncertainty values through the conditional parameter `na_action`. 

The options are:

1. **NA as zero**, assigns zero to all NA values,
```
Unc_Meters_to_DecDeg_NAZero <-
  meters_to_decdeg(
    occs_df,
    lat_col = "latitude",
    lon_col = "longitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as 0"
    )
```

```{r uncertainty from meter to radian degrees NA as 0, echo=FALSE}
L_wiedii_uncertainty_naZero <-
  meters_to_decdeg(occs_df = Leopardus_wiedii_gbif,
    lat_col = "latitude",
    lon_col = "longitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as 0")

knitr::kable(head(L_wiedii_uncertainty_naZero))
```

2. **NA as NA**, leaves NA values as NA, and 
```
Unc_Meters_to_DecDeg_NANA <-
  meters_to_decdeg(
    occs_df,
    lat_col = "latitude",
    lon_col = "longitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as NA"
    )
```

```{r uncertainty from meter to radian degrees NA as NA, echo=FALSE}
L_wiedii_uncertainty_naNA <-
  meters_to_decdeg(occs_df = Leopardus_wiedii_gbif,
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as NA")

knitr::kable(head(L_wiedii_uncertainty_naNA))
```

3. **NA as mean**, assigns the non-NA uncertainty mean value to NA values.
```
Unc_Meters_to_DecDeg_NAMean <-
  meters_to_decdeg(
    occs_df,
    lat_col = "latitude",
    lon_col = "longitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as mean"
    )
```

```{r uncertainty from meter to radian degrees NA as mean, echo=FALSE}
L_wiedii_uncertainty_naMean <-
  meters_to_decdeg(occs_df = Leopardus_wiedii_gbif,
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as mean")

knitr::kable(head(L_wiedii_uncertainty_naMean))
```

***Note*: The rest of this vignette will use the conditional na_action = "NA as mean"

# 3. `generate_occ_uncertain` function

The function `generate_occ_uncertain` produces a random latitude and longitude coordinates data frame, accounting latitude and longitude uncertainty values in decimal degrees. The function requires to have an input data.frame with at least four columns in decimal degrees and the species name:

1. Latitude.
2. Longitude.
3. Latitude uncertainty.
4. Longitude uncertainty.
5. Species.

```{r NA as mean, echo=FALSE}
#combine observed and prodataset with radian 
L_wiedii_uncertainty_naMean <-
  cbind(Leopardus_wiedii_gbif, L_wiedii_uncertainty_naMean)
colnames(L_wiedii_uncertainty_naMean)

L_wiedii_uncertainty_naMean <-
  dplyr::select(
    L_wiedii_uncertainty_naMean,
    latitude,
    longitude,
    lon_uncertainty,
    lat_uncertainty,
    species
  )

knitr::kable(head(L_wiedii_uncertainty_naMean))
```
```
L_wiedii_random <-
  generate_occ_uncertain(
    occ_df,
    lat_col = "latitude",
    lon_col = "longitude",
    lat_uncertainty = "lat_uncertainty",
    lon_uncertainty = "lon_uncertainty",
    taxa_col = "species"
  )
```  
```{r generate, echo=FALSE}
L_wiedii_random <-
  generate_occ_uncertain(
    L_wiedii_uncertainty_naMean,
    lat_col = "latitude",
    lon_col = "longitude",
    lat_uncertainty = "lat_uncertainty",
    lon_uncertainty = "lon_uncertainty",
    taxa_col = "species"
  )

knitr::kable(head(L_wiedii_random))
```

## Lets visualize 
```{r echo=FALSE, fig.width = 7, fig.height= 7, dev.args=list(pointsize=2)}
#observed occurrences
plot(Leopardus_wiedii_gbif$longitude, Leopardus_wiedii_gbif$latitude, pch = 19, col = "black", xlab = "Longitude", ylab = "Latitude", 
  main = "L. wiedii observed and generated occurrence points"
  )
#generated occurences
points(
  L_wiedii_random$lon_random,
  L_wiedii_random$lat_random,
  col = "red",
  pch = 21
)
#add legend
legend(
  "bottomleft",
  legend = c("NA as mean generated occurrences", "observed occurrences"),
  col = c("red", "black"),
  pch = c(21, 19),
  cex = 0.8
)
plot(land, add=T)
```
You can add easily get a map of countries using the package [rnaturalearth](https://CRAN.R-project.org/package=rnaturalearth):
```{r include=TRUE, echo = TRUE, dev.args=list(pointsize=2)}
land <- 
  rnaturalearth::ne_countries(scale = 50, returnclass = "sp")
```
```

# 4. `random_geo_range` function
The function `random_geo_range` accounts for uncertainty and uses a for loop to randomize occurence points. Produces a data frame with values for extent of occurrence (EOO)and area of occupancy (AOO), with ConR package functions (compute.EOO and compute.AOO). The function requires an input data frame with three different columns in order:

1. lat_random: Latitude in decimal degrees
2. lon_random: Longitude in decimal degrees
3. Name of taxa

>The Extent of Occurrence is the area contained within the shortest continuous imaginary boundary which can be drawn to encompass all the known, inferred or projected sites of present occurrence of a taxon, excluding cases of vagrancy. (IUCN 2012)

The function logical argument exclude.area, crops areas not suitable for the species. The excluded areas are defined by a shapefile with the argument country_map. Note that it is mandatory to provide a shapefile for country_map if exclude.area is TRUE. 

>The area occupied by a taxon within its extent of occurrence; known as Area of occupancy (AOO), reflects the fact that a taxon will not usually occur throughout the area of its extent of occurrence. Metric calculatlaed as the area of all known or predicted cells for the species, without unsuitable or unoccupied habitats. The resolution will be 2x2km as required by IUCN.

For this example, the funtion `random_geo_range` uses n_length = 10, to randomly generate latitudes and longitudes occurrences with the function `generate_occ_uncertain`, using mean uncertainty for NA values obtained with `meters_to_decdeg`.  
```
L_weidii_random_geo_range <- random_geo_range(
  n_length = 10,
  occs_df,
  lat_col = "latitude",
  lon_col = "longitude",
  lon_uncertainty = "lon_uncertainty",
  lat_uncertainty = "lat_uncertainty",
  taxa_col = "species"
)
```

```{r file, include=FALSE}
library(ConR)
L_weidii_random_geo_range <- random_geo_range(
  n_length = 10,
  occs_df = L_wiedii_uncertainty_naMean,
  lat_col = "latitude",
  lon_col = "longitude",
  lon_uncertainty = "lon_uncertainty",
  lat_uncertainty = "lat_uncertainty",
  taxa_col = "species"
)
```

```{r echo=FALSE}
knitr::kable(head(L_weidii_random_geo_range))
```

```{r EOO, eval=FALSE, include=FALSE}
## 5 Computing from observed dataset with ConR 
library(ConR)
data(land)
L_weidii_EOO <-
  EOO.computing(
    Leopardus_wiedii_random,
    exclude.area = T,
    country_map = land,
    write_results = F
  )

L_weidii_AOO <- AOO.computing(Leopardus_wiedii_random)
```

```{r IUCN, eval=FALSE, include=FALSE}
## 6.4 Runing IUCN.eval function## 6.4 Runing IUCN.eval function
L_weidii_IUCN.eval <- IUCN.eval(Leopardus_wiedii_random,
  country_map = land,
  write_results = F)
```
